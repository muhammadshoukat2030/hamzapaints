<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>View Agent</title>
  <link rel="icon" href="/images/weldon-paints-logo.png" type="image/png">
  <link rel="stylesheet" href="/stylesheets/viewAgent.css">
</head>
<body>
<%- include('partials/navbar') %>

<main>
<h1>View Agent - <%= agent.name %></h1>

<!-- Filter Section -->
<form class="filter-container" method="GET" action="/agents/view-agent/<%= agent._id %>">
  <select name="filter" id="filter" onchange="toggleDateInputs(this.value)">
    <option value="all" <%= filter === 'all' ? 'selected' : '' %>>All Dates</option>
    <option value="today" <%= filter === 'today' ? 'selected' : '' %>>Today</option>
    <option value="yesterday" <%= filter === 'yesterday' ? 'selected' : '' %>>Yesterday</option>
    <option value="month" <%= filter === 'month' ? 'selected' : '' %>>This Month</option>
    <option value="lastMonth" <%= filter === 'lastMonth' ? 'selected' : '' %>>Last Month</option>
    <option value="custom" <%= filter === 'custom' ? 'selected' : '' %>>Custom Range</option>
  </select>

  <input type="date" name="from" id="from" value="<%= from || '' %>" style="display:none;">
  <input type="date" name="to" id="to" value="<%= to || '' %>" style="display:none;">
  <button type="submit" id="apply">Apply</button>
</form>

<!-- Stats Section -->
<div class="stats">
  <div class="stat-box">
    <h3>Total % Amount</h3>
    <p>Rs <%= stats.totalPercentageAmount.toFixed(2) %></p>
  </div>
  <div class="stat-box">
    <h3>Total % Paid</h3>
    <p>Rs <%= stats.totalPercentageAmountGiven.toFixed(2) %></p>
  </div>
  <div class="stat-box">
    <h3>Total % Left</h3>
    <p>Rs <%= stats.totalPercentageAmountLeft.toFixed(2) %></p>
  </div>
</div>



<!-- Items Table -->
<table>
  <thead>
    <tr>
      <th>Product Sold</th>
      <th>Product Amount</th>
      <th>%</th>
      <th>% Amount</th>
      <th>Item Status</th>
      <th>Paid Amount</th>
      <th>Left Amount</th>
      <th>Register Date</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody>
    <% if (agent.items.length === 0) { %>
      <tr>
        <td colspan="8" class="no-data">No items found for the selected filter.</td>
      </tr>
    <% } else { %>
      <% agent.items.forEach(i => { %>
        <tr id="row-<%= i._id %>">
          <td><%= i.totalProductSold %></td>
          <td><%= i.totalProductAmount %></td>
          <td><%= i.percentage %></td>
          <td><%= i.percentageAmount %></td>
          <td class="paid-status">
            <% if (i.paidAmount >= i.percentageAmount) { %>
              Paid
            <% } else if (i.paidAmount > 0) { %>
              Partially
            <% } else { %>
              Unpaid
            <% } %>
          </td>
          <td>Rs <%= i.paidAmount %></td>
          <td>Rs <%= i.percentageAmount - i.paidAmount %></td>
          <td><%= new Date(i.createdAt).toLocaleDateString() %></td>
          <td>
  <!-- Pay Button -->
  <button onclick="openPayBox('<%= i._id %>', '<%= i.percentageAmount %>', '<%= i.paidAmount %>')" id="pay">
    Pay
  </button>

  

  <!-- Pay Input Box -->
  <div id="paybox-<%= i._id %>" style="display:none; margin-top: 5px;">
    <input type="number" id="payInput-<%= i._id %>" placeholder="Enter Amount" min="1">
    <button onclick="submitPayment('<%= i._id %>', '<%= i.percentageAmount %>', '<%= i.paidAmount %>')" id="submit">
      Submit
    </button>
  </div>
</td>

        </tr>
      <% }) %>
    <% } %>
  </tbody>
</table>
</main>
<script>
function toggleDateInputs(value) {
  const from = document.getElementById("from");
  const to = document.getElementById("to");
  from.style.display = value === "custom" ? "inline-block" : "none";
  to.style.display = value === "custom" ? "inline-block" : "none";
}

function openPayBox(id, total, paid) {
  total = Number(total);
  paid = Number(paid);
  const box = document.getElementById(`paybox-${id}`);
  box.style.display = box.style.display === "none" ? "block" : "none";
}

async function submitPayment(id, total, paid) {
  total = Number(total);
  paid = Number(paid);

  const input = document.getElementById(`payInput-${id}`);
  const addAmount = Number(input.value);

  if (!addAmount || addAmount <= 0) {
    alert("Enter valid amount");
    return;
  }

  if (paid + addAmount > total) {
    alert("‚ùå Amount cannot exceed percentage amount!");
    return;
  }

  const res = await fetch(`/agents/pay-item/${id}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ amount: addAmount })
  });

  const data = await res.json();

  if (data.success) {
    alert("Payment Added Successfully!");
    location.reload();
  } else {
    alert("Payment Failed!");
  }
}



async function deleteItem(itemId) {
  if (!confirm("Are you sure you want to delete this item?")) return;

  try {
    const res = await fetch(`/agents/delete-item/${itemId}`, { method: "DELETE" });
    const data = await res.json();
    if (data.success) {
      alert("Item deleted successfully!");
      location.reload();
    } else {
      alert("Failed to delete Item");
    }
  } catch (err) {
    alert("Error deleting item");
  }
}
</script>





</body>
</html>
