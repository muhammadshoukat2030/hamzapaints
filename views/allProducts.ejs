<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>All Products | Hamza Paints</title>
  <link rel="icon" href="/images/weldon-paints-logo.png" type="image/png">
  <link rel="stylesheet" href="/stylesheets/allProducts.css">
</head>

<body>
  <%- include('partials/navbar') %>

  <main>
    <h1>All Products Inventory</h1>

    <form class="filter-container" method="GET" action="/products/all" id="filterForm">
      <select name="filter" id="filter">
        <option value="all" <%= filter === 'all' ? 'selected' : '' %>>All Times</option>
        <option value="today" <%= filter === 'today' ? 'selected' : '' %>>Today</option>
        <option value="yesterday" <%= filter === 'yesterday' ? 'selected' : '' %>>Yesterday</option>
        <option value="month" <%= (filter === 'month' || !filter) ? 'selected' : '' %>>This Month</option>
        <option value="lastMonth" <%= filter === 'lastMonth' ? 'selected' : '' %>>Last Month</option>
        <option value="custom" <%= filter === 'custom' ? 'selected' : '' %>>Custom Range</option>
      </select>

      <select name="brand" id="brandFilter">
        <option value="all" <%= selectedBrand === 'all' ? 'selected' : '' %>>All Brands</option>
        <% definitions.forEach(def => { %>
          <option value="<%= def.brandName %>" <%= selectedBrand === def.brandName ? 'selected' : '' %>><%= def.brandName %></option>
        <% }) %>
      </select>

      <select name="itemName" id="itemNameFilter">
        <option value="all">All Items</option>
      </select>

      <select name="colourName" id="colourNameFilter">
        <option value="all">All Colors</option>
      </select>

      <select name="unit" id="unitFilter">
        <option value="all">All Units</option>
      </select>

      <select name="stockStatus" id="stockStatusFilter">
        <option value="all" <%= stockStatus === 'all' ? 'selected' : '' %>>All Stock</option>
        <option value="in" <%= stockStatus === 'in' ? 'selected' : '' %>>In Stock</option>
        <option value="out" <%= stockStatus === 'out' ? 'selected' : '' %>>Out of Stock</option>
      </select>

      <select name="refund" id="refundFilter">
        <option value="all" <%= selectedRefund === 'all' ? 'selected' : '' %>>All Status</option>
        <option value="none" <%= selectedRefund === 'none' ? 'selected' : '' %>>Not Refunded</option>
        <option value="both" <%= selectedRefund === 'both' ? 'selected' : '' %>>Both (Partial & Full)</option>
        <option value="Partially Refunded" <%= selectedRefund === 'Partially Refunded' ? 'selected' : '' %>>Partially Refunded</option>
        <option value="Fully Refunded" <%= selectedRefund === 'Fully Refunded' ? 'selected' : '' %>>Fully Refunded</option>
      </select>

      <input type="date" name="from" id="from" value="<%= from || '' %>" style="display:none;">
      <input type="date" name="to" id="to" value="<%= to || '' %>" style="display:none;">
      <button type="submit" id="apply" style="display:none;">Apply Range</button>
    </form>

    <div class="stats">
      <div class="stat-box">
        <h3><span style="font-size: 17px;">üõí</span>Total Products</h3>
        <p><%= stats.totalStock || 0 %></p>
      </div>
      <div class="stat-box">
        <h3><span style="font-size: 17px;">üí∞</span>Products Value</h3>
        <p>Rs <%= stats.totalValue ? stats.totalValue.toLocaleString() : '0.00' %></p>
      </div>
      <div class="stat-box">
        <h3><span style="font-size: 17px;">üß±</span>Items In Stock</h3>
        <p><%= stats.totalRemaining || 0 %></p>
      </div>
      <div class="stat-box">
        <h3><span style="font-size: 17px;">üíπ</span>Remaining Value</h3>
        <p>Rs <%= stats.remaining ? stats.remaining.toLocaleString() : '0.00' %></p>
      </div>
      <div class="stat-box">
        <h3>‚Ü©Ô∏èRefunded Value</h3>
        <p id="refund-stock">Rs <%= stats.totalRefundedValue ? stats.totalRefundedValue.toLocaleString() : '0.00' %></p>
      </div>
    </div>

    <div class="table-container" id="tableContainer">
      <div id="table-loader" style="display: none;">
        <div class="spinner"></div>
        <p style="margin-top:10px; color:#06A56C; font-weight: bold;">Updating...</p>
      </div>

      <table>
        <thead>
          <tr>
            <th>Stock ID</th>
            <th>Brand</th>
            <th>Item</th>
            <th>Color</th>
            <th>Unit</th>
            <th>Total Prod</th>
            <th>Remaining</th>
            <th>Rate</th>
            <th>Total Amount</th>
            <th>Status</th>
            <th>Refund</th>
            <th>Date</th>
            <% if(role == "admin"){ %>
              <th>Action</th>
            <% } %>
          </tr>
        </thead>
        <tbody>
          <% if (products.length === 0) { %>
            <tr>
              <td colspan="13" class="no-data">No products found for the selected filter.</td>
            </tr>
          <% } else { %>
            <% products.forEach(p => { %>
              <tr>
                <td><strong><%= p.stockID %></strong></td>
                <td><%= p.brandName %></td>
                <td><%= p.itemName %></td>
                <td><%= p.colourName %></td>
                <td><%= p.qty %></td>
                <td><%= p.totalProduct %></td>
                <td class="stock-<%= p.remaining <= 0 ? 'red' : 'green' %>">
               <%= p.remaining %>
               </td>


                <td>Rs <%= p.rate %></td>
                <td>Rs <%= (p.totalProduct * p.rate).toFixed(2) %></td>
                <td class="refund-status"><%= p.refundStatus %></td>
                <td class="refund-quantity"><%= p.refundQuantity || 0 %></td>
                <td>
                  <%= new Date(p.createdAt).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric', timeZone: 'Asia/Karachi' }) %>
                  <br>
                  <small style="color: #007bff; font-weight: bold;">
                    <%= new Date(p.createdAt).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: true, timeZone: 'Asia/Karachi' }) %>
                  </small>
                </td>
                <% if(role == "admin"){ %>
                  <td><button type="button" class="delete-btn" data-id="<%= p._id %>"  id="delete">Delete</button></td>
                <% } %>
              </tr>
            <% }) %>
          <% } %>
        </tbody>
      </table>
    </div>

    <div id="db-data-provider" data-definitions='<%= JSON.stringify(definitions) %>' style="display: none;"></div>
  </main>

  <script>
    // Server-side variables pass to JavaScript
    window.selectedBrand = "<%= selectedBrand || 'all' %>";
    window.selectedItem = "<%= selectedItem || 'all' %>";
    window.selectedColour = "<%= selectedColour || 'all' %>";
    window.selectedUnit = "<%= selectedUnit || 'all' %>";
  </script>

  <script src="/javascripts/allProducts.js"></script>

</body>
</html>